name: Run Playwright headless tests on main updates

on:
  # å½“æœ¬ä»“åº“çš„ main åˆ†æ”¯æœ‰ä»£ç æ›´æ–°ï¼ˆpushï¼‰æ—¶è§¦å‘
  push:
    branches:
      - main

jobs:
  test-playwright-headless:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç‰ˆæœ¬ï¼Œå¹¶å¯ç”¨ pnpm ç¼“å­˜
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3. å®‰è£… pnpmï¼ˆé¿å… "Unable to locate executable file: pnpm" é”™è¯¯ï¼‰
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      # 4. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. å®‰è£… Playwright æµè§ˆå™¨ï¼ˆåŒ…å«ç³»ç»Ÿä¾èµ–ï¼‰
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      # 6. è¿è¡Œ Playwright å¤´less æµ‹è¯•è„šæœ¬
      - name: build wallet tests (headless)
        run: pnpm run build:cache:headless

      # 7. è¿è¡Œ Playwright å¤´less æµ‹è¯•è„šæœ¬
      - name: Run Playwright tests (headless)
        run: pnpm run test:playwright:headless
        continue-on-error: true # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œï¼Œä»¥ä¾¿ä¸Šä¼ æˆªå›¾å’Œè§†é¢‘

      # 8. ä¸Šä¼ æµ‹è¯•ç»“æœï¼ˆåŒ…å«æˆªå›¾ã€è§†é¢‘å’Œ trace æ–‡ä»¶ï¼‰
      - name: Upload test results
        if: always() # æ— è®ºæµ‹è¯•æˆåŠŸæˆ–å¤±è´¥éƒ½ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        id: upload-artifact
        with:
          name: playwright-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30 # ä¿ç•™ 30 å¤©
          if-no-files-found: ignore # å¦‚æœæ²¡æœ‰æ–‡ä»¶ä¹Ÿä¸æŠ¥é”™

      # 9. è¾“å‡º Artifact ä¸‹è½½é“¾æ¥ï¼ˆæ–¹ä¾¿æŸ¥çœ‹ï¼‰
      - name: Output artifact download link
        if: always()
        run: |
          echo "ğŸ“¦ Artifact å·²ä¸Šä¼ ï¼"
          echo "ğŸ”— æŸ¥çœ‹å’Œä¸‹è½½é“¾æ¥ï¼š"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ’¡ æç¤ºï¼š"
          echo "   1. ç‚¹å‡»ä¸Šé¢çš„é“¾æ¥è¿›å…¥ workflow run é¡µé¢"
          echo "   2. æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨æ‰¾åˆ° 'Artifacts' åŒºåŸŸ"
          echo "   3. ç‚¹å‡» 'playwright-test-results' å³å¯ä¸‹è½½"
          echo ""
          echo "ğŸ“ Artifact åŒ…å«ï¼š"
          echo "   - test-results/ (æˆªå›¾ã€è§†é¢‘ã€trace æ–‡ä»¶)"
          echo "   - playwright-report/ (HTML æµ‹è¯•æŠ¥å‘Š)"
