import{f as M}from"./chunk-77RLIZ3K.js";import{jc as A}from"./chunk-Q2TGNWPS.js";import{Kb as C}from"./chunk-4HRGOILD.js";import{a as o,i as u,n as d}from"./chunk-NSVULBS3.js";u();d();var F=C({authRepository:M,queryClient:A});u();d();u();d();u();d();var f=o(n=>`sq:doc:value:${n}`,"valueKeyFor"),g=o(n=>`sq:doc:refCount:${n}`,"refCountKeyFor"),l=o(n=>`sq:doc:refIds:${n}`,"refIdsKeyFor"),w=o(n=>`sq:doc:updatedAt:${n}`,"updatedAtKeyFor"),y=o(n=>`sq:doc:queue:${n}`,"queueKeyFor"),W=50,S=1e3*60*60*24;var m=class{static{o(this,"AsyncQueryStore")}isWriter;delegate;sendMessage;messageQueue=[];queues=new Map;queueProcessorPromise;resolveQueueWait;constructor(e){this.isWriter=e.isWriter,this.delegate=e.delegate;let{sendMessage:s}=e.connect(this.handleMessage.bind(this));if(this.sendMessage=s,this.isWriter){if(!this.delegate)throw new Error("Writer must have a delegate");this.startQueueProcessor()}}handleMessage(e){this.isWriter&&this.enqueueMessage(e)}enqueueMessage(e){this.messageQueue.push(e),this.resolveQueueWait&&(this.resolveQueueWait(),this.resolveQueueWait=void 0)}startQueueProcessor(){this.queueProcessorPromise=this.processQueue()}async processQueue(){for(;;){for(;this.messageQueue.length===0;)await new Promise(s=>{this.resolveQueueWait=s});let e=this.messageQueue.shift();try{await this.processMessage(e)}catch(s){console.error("Error processing message:",s)}}}async processMessage(e){switch(e.type){case"saveQuery":await this.writerSaveQuery(e.queryDefId,e.queryKey,e.value,e.updatedAt,e.refIds);break;case"saveEntity":await this.writerSaveEntity(e.entityKey,e.value,e.refIds);break;case"activateQuery":await this.writerActivateQuery(e.queryDefId,e.queryKey);break}}async loadQuery(e,s,t){if(!this.delegate)return;let r=await this.delegate.getNumber(w(s));if(r===void 0||r<Date.now()-(e.cache?.gcTime??S))return;let a=await this.delegate.getString(f(s));if(a===void 0)return;let i=await this.delegate.getBuffer(l(s));return i!==void 0&&await this.preloadEntities(i,t),this.activateQuery(e,s),{value:JSON.parse(a),refIds:i===void 0?void 0:new Set(i??[]),updatedAt:r}}async preloadEntities(e,s){if(this.delegate)for(let t of e){let r=await this.delegate.getString(f(t));if(r===void 0)continue;let a=JSON.parse(r);s.setPreloadedEntity(t,a);let i=await this.delegate.getBuffer(l(t));i!==void 0&&await this.preloadEntities(i,s)}}saveQuery(e,s,t,r,a){let i={type:"saveQuery",queryDefId:e.id,queryKey:s,value:t,updatedAt:r,refIds:a?Array.from(a):void 0};this.isWriter?this.enqueueMessage(i):this.sendMessage(i)}saveEntity(e,s,t){let r={type:"saveEntity",entityKey:e,value:s,refIds:t?Array.from(t):void 0};this.isWriter?this.enqueueMessage(r):this.sendMessage(r)}activateQuery(e,s){let t={type:"activateQuery",queryDefId:e.id,queryKey:s};this.isWriter?this.enqueueMessage(t):this.sendMessage(t)}async writerSaveQuery(e,s,t,r,a){await this.setValue(s,t,a?new Set(a):void 0),await this.delegate.setNumber(w(s),r),await this.writerActivateQuery(e,s)}async writerSaveEntity(e,s,t){await this.setValue(e,s,t?new Set(t):void 0)}async writerActivateQuery(e,s){if(!await this.delegate.has(f(s)))return;let t=this.queues.get(e);if(t===void 0){let i=W;t=await this.delegate.getBuffer(y(e)),t===void 0?(t=new Uint32Array(i),await this.delegate.setBuffer(y(e),t)):t.length!==i&&(t=new Uint32Array(t.buffer,0,i),await this.delegate.setBuffer(y(e),t)),this.queues.set(e,t)}let r=t.indexOf(s);if(r>=0){if(r===0)return;t.copyWithin(1,0,r),t[0]=s;return}let a=t[t.length-1];t.copyWithin(1,0,t.length-1),t[0]=s,a!==0&&(await this.deleteValue(a),await this.delegate.delete(w(a)))}async setValue(e,s,t){let r=this.delegate;await r.setString(f(e),JSON.stringify(s));let a=l(e),i=await r.getBuffer(a);if(t===void 0||t.size===0){if(await r.delete(a),i!==void 0)for(let h=0;h<i.length;h++){let c=i[h];await this.decrementRefCount(c)}}else{let h=new Uint32Array(t);if(i!==void 0)for(let c=0;c<i.length;c++){let p=i[c];t.has(p)?t.delete(p):await this.decrementRefCount(p)}for(let c of t)await this.incrementRefCount(c);await r.setBuffer(a,h)}}async deleteValue(e){let s=this.delegate;await s.delete(f(e)),await s.delete(g(e));let t=await s.getBuffer(l(e));if(await s.delete(l(e)),t!==void 0)for(let r of t)r!==0&&await this.decrementRefCount(r)}async incrementRefCount(e){let s=this.delegate,t=g(e),a=(await s.getNumber(t)??0)+1;await s.setNumber(t,a)}async decrementRefCount(e){let s=this.delegate,t=g(e),r=await s.getNumber(t);if(r===void 0)return;let a=r-1;a===0?await this.deleteValue(e):await s.setNumber(t,a)}};var Q=class{static{o(this,"ChromeExtensionPersistentStore")}async has(e){let s=await chrome.storage.local.get(e);return e in s}async getString(e){let t=(await chrome.storage.local.get(e))[e];return t===void 0?void 0:String(t)}async setString(e,s){await chrome.storage.local.set({[e]:s})}async getNumber(e){let t=(await chrome.storage.local.get(e))[e];return t===void 0?void 0:Number(t)}async setNumber(e,s){await chrome.storage.local.set({[e]:s})}async getBuffer(e){let t=(await chrome.storage.local.get(e))[e];if(t!==void 0&&Array.isArray(t))return new Uint32Array(t)}async setBuffer(e,s){await chrome.storage.local.set({[e]:Array.from(s)})}async delete(e){await chrome.storage.local.remove(e)}};function E(n){let e=n.portName??"signalium-query-store";return s=>{if(n.isWriter)return chrome.runtime.onConnect.addListener(t=>{t.name===e&&t.onMessage.addListener(r=>{s(r)})}),{sendMessage:o(()=>{},"sendMessage")};{let t=chrome.runtime.connect({name:e});return{sendMessage:o(r=>{try{t.postMessage(r)}catch(a){console.error("Failed to send message to background:",a)}},"sendMessage")}}}}o(E,"createChromeExtensionConnection");var D=o((n={isWriter:!1})=>new m({isWriter:n?.isWriter??!1,connect:E(n),delegate:n.isWriter?new Q:void 0}),"createChromeStorageStore");export{F as a,D as b};
//# sourceMappingURL=chunk-L6SN4W4V.js.map
